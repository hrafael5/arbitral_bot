<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Entrada</title>
    <style>
        body { 
            font-family: 'Segoe UI', 'Roboto', sans-serif; 
            margin: 0; 
            background-color: #161b22; 
            color: #c9d1d9; 
            font-size: 14px; 
            min-height: 180px;
            min-width: 280px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden; 
        }
        .popup-container { 
            background-color: #0d1117; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            width: 100%; 
            max-width: 380px;
            height: auto;
            box-sizing: border-box; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            border: 1px solid #30363d;
        }
        .pair-header {
            font-size: 22px; 
            font-weight: 500;
            margin-bottom: 2px;
            color: #adb5bd;
            text-align: center;
        }
        .entry-label {
            font-size: 10px;
            color: #8b949e; 
            margin-bottom: 10px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .data-row {
            display: flex;
            justify-content: space-around; 
            align-items: flex-start; 
            width: 100%;
            margin-bottom: 12px; 
            padding: 0 5px; 
            box-sizing: border-box;
            gap: 5px; 
        }
        .data-column {
            text-align: center;
            flex: 1 1 0; 
            min-width: 70px;
        }
        .data-column.center {
            border-left: 1px solid #30363d;
            border-right: 1px solid #30363d;
            padding: 0 8px; 
            margin: 0 3px; 
            flex: 1.5 1 0;
        }
        .data-column .label {
            font-size: 9px; 
            color: #8b949e;
            margin-bottom: 2px;
            display: block;
            text-transform: uppercase;
            white-space: nowrap; 
        }
        .data-column .value {
            font-size: 16px;
            font-weight: 500;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            word-break: break-all; 
        }
        .data-column.center .value#popupProfitE {
            font-size: 22px;
            font-weight: 600;
        }
        .profit-value.positive { color: #3fb950; } 
        .profit-value.negative { color: #f85149; } 
        .profit-value.zero { color: #8b949e; }
        .sub-profit-container {
            margin-top: 2px; 
        }
        .sub-profit-container .label-s {
            font-size: 8px; 
            color: #8b949e;
            text-transform: none; 
            display: block;
        }
        .sub-profit-container .value-s {
            font-size: 12px; 
            font-weight: 500;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
        }
        .actions-footer {
            display: flex;
            justify-content: center; 
            align-items: center;
            width: 100%;
            margin-top: 5px; 
            padding-top: 10px; 
            border-top: 1px solid #30363d;
        }
        #openChartButton { 
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            background-color: #238636; 
            color: white;
            border: 1px solid #2ea043;
            border-radius: 6px;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        #openChartButton:hover {
            background-color: #2ea043; 
        }
    </style>
</head>
<body>
    <div class="popup-container">
        <div class="pair-header">
            <span id="popupPairDisplay">PAR</span>
        </div>
        <div class="entry-label">Entrada</div>
        
        <div class="data-row">
            <div class="data-column">
                <span class="label"><span id="popupLeg1Exchange">EX1</span> (<span id="popupLeg1Instrument">S</span>)</span>
                <span class="value" id="popupLeg1Price">0.00000</span>
            </div>
            <div class="data-column center">
                <span class="label">Lucro E</span>
                <span class="value profit-value zero" id="popupProfitE">-0.00%</span>
                <div class="sub-profit-container">
                    <span class="label-s">Lucro S (Inverso):</span>
                    <span class="value-s profit-value zero" id="popupProfitS">-0.00%</span>
                </div>
            </div>
            <div class="data-column">
                <span class="label"><span id="popupLeg2Exchange">EX2</span> (<span id="popupLeg2Instrument">F</span>)</span>
                <span class="value" id="popupLeg2Price">0.00000</span>
            </div>
        </div>

        <div class="actions-footer">
            <button id="openChartButton">Abrir Gráficos (2)</button>
        </div>
    </div>

    <script>
        // Variáveis globais para o estado do popup
        let pair = '';
        let entryBuyExName = 'mexc';
        let entrySellExName = 'mexc';
        let entryBuyInstrument = 'S';
        let entrySellInstrument = 'F';

        // Seletores de elementos do DOM
        const popupPairDisplayEl = document.getElementById('popupPairDisplay');
        const popupLeg1ExchangeEl = document.getElementById('popupLeg1Exchange');
        const popupLeg1InstrumentEl = document.getElementById('popupLeg1Instrument');
        const popupLeg1PriceEl = document.getElementById('popupLeg1Price');
        const popupProfitEEl = document.getElementById('popupProfitE');
        const popupProfitSEl = document.getElementById('popupProfitS');
        const popupLeg2ExchangeEl = document.getElementById('popupLeg2Exchange');
        const popupLeg2InstrumentEl = document.getElementById('popupLeg2Instrument');
        const popupLeg2PriceEl = document.getElementById('popupLeg2Price');
        const openChartButtonEl = document.getElementById('openChartButton');

        // Funções de formatação
        function getRelevantDecimals(price) {
            if (price === null || price === undefined || isNaN(price)) return 7;
            const absPrice = Math.abs(price);
            if (absPrice >= 100) return 2;
            if (absPrice >= 1) return 4;
            if (absPrice >= 0.01) return 5;
            if (absPrice >= 0.0001) return 6;
            return 7;
        }
        
        function formatPriceForDisplay(price) {
            if (typeof price !== 'number' || isNaN(price)) return '...';
            return price.toFixed(getRelevantDecimals(price));
        }

        function formatProfitPercentageForDisplay(profitPercentage, element) {
            if (!element) return;
            let textToShow = "Aguardando...";
            let baseClassName = element.id === 'popupProfitS' ? 'value-s profit-value' : 'value profit-value';
            let finalClassName = `${baseClassName} zero`;

            if (typeof profitPercentage === 'number' && !isNaN(profitPercentage)) {
                textToShow = (profitPercentage >= 0 ? '+' : '') + profitPercentage.toFixed(2) + '%';
                if (profitPercentage > 0.009) finalClassName = `${baseClassName} positive`;
                else if (profitPercentage < -0.009) finalClassName = `${baseClassName} negative`;
            }
            element.textContent = textToShow;
            element.className = finalClassName;
        }

        // Função que busca dados ao vivo da janela principal
        function updateWithLiveData() {
            if (!window.opener || window.opener.closed) {
                if (window.profitUpdateInterval) clearInterval(window.profitUpdateInterval);
                return;
            }
            
            const mainState = window.opener.frontendState;
            if (!mainState || !mainState.allPairsData || !mainState.config) {
                return; // Aguarda o estado principal estar pronto
            }
            
            try {
                const configEntryBuyEx = mainState.config.exchanges[entryBuyExName.toLowerCase()];
                const configEntrySellEx = mainState.config.exchanges[entrySellExName.toLowerCase()];

                if (!configEntryBuyEx || !configEntrySellEx) return;

                const feeForEntryBuyOrder = entryBuyInstrument.toUpperCase().includes('SPOT') ? parseFloat(configEntryBuyEx.spotMakerFee) : parseFloat(configEntryBuyEx.futuresMakerFee);
                const feeForEntrySellOrder = entrySellInstrument.toUpperCase().includes('SPOT') ? parseFloat(configEntrySellEx.spotMakerFee) : parseFloat(configEntrySellEx.futuresMakerFee);
                
                const marketDataForEntryBuyLeg = mainState.allPairsData.find(p => p.pair === pair && p.exchange.toLowerCase() === entryBuyExName.toLowerCase());
                const marketDataForEntrySellLeg = mainState.allPairsData.find(p => p.pair === pair && p.exchange.toLowerCase() === entrySellExName.toLowerCase());

                if (marketDataForEntryBuyLeg && marketDataForEntrySellLeg) {
                    const liveBuyPrice = entryBuyInstrument.toUpperCase().includes('SPOT') ? marketDataForEntryBuyLeg.spotPrice : marketDataForEntryBuyLeg.futuresPrice;
                    const liveSellPrice = entrySellInstrument.toUpperCase().includes('SPOT') ? marketDataForEntrySellLeg.spotBid : marketDataForEntrySellLeg.futuresBid;
                    
                    // Atualiza a exibição de preços ao vivo
                    popupLeg1PriceEl.textContent = formatPriceForDisplay(liveBuyPrice);
                    popupLeg2PriceEl.textContent = formatPriceForDisplay(liveSellPrice);

                    // Recalcula e exibe o Lucro E (Entrada) ao vivo
                    if (typeof liveBuyPrice === 'number' && typeof liveSellPrice === 'number' && liveBuyPrice > 0) {
                        const grossSpread = (liveSellPrice / liveBuyPrice) - 1;
                        const netSpread = (grossSpread - feeForEntryBuyOrder - feeForEntrySellOrder) * 100;
                        formatProfitPercentageForDisplay(netSpread, popupProfitEEl);
                    }

                    // Recalcula e exibe o Lucro S (Saída) ao vivo
                    const lucroS_val = window.opener.calculateLucroS({
                        buyExchange: entryBuyExName, sellExchange: entrySellExName,
                        buyInstrument: entryBuyInstrument, sellInstrument: entrySellInstrument, pair: pair
                    }, mainState.allPairsData, mainState.config);
                    formatProfitPercentageForDisplay(lucroS_val, popupProfitSEl);
                }
            } catch (e) {
                console.error("Erro durante a atualização ao vivo:", e);
            }
        }

        // Função principal que é executada quando a janela carrega
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            
            // Pega os dados da URL
            pair = params.get('pair');
            entryBuyExName = params.get('buyEx');
            entrySellExName = params.get('sellEx');
            entryBuyInstrument = params.get('buyInst');
            entrySellInstrument = params.get('sellInst');
            const initialBuyPrice = parseFloat(params.get('buyPrice'));
            const initialSellPrice = parseFloat(params.get('sellPrice'));
            
            if (!pair) {
                document.body.innerHTML = '<h1>Erro: Par não especificado.</h1>';
                return;
            }

            document.title = `Entrada: ${pair}`;

            // **EXIBIÇÃO INICIAL E IMEDIATA DOS DADOS**
            popupPairDisplayEl.textContent = pair.split('/')[0];
            popupLeg1ExchangeEl.textContent = entryBuyExName.length > 4 ? entryBuyExName.substring(0, 4).toUpperCase() : entryBuyExName.toUpperCase();
            popupLeg1InstrumentEl.textContent = entryBuyInstrument.toUpperCase().includes('SPOT') ? 'S' : 'F';
            popupLeg1PriceEl.textContent = formatPriceForDisplay(initialBuyPrice);
            
            popupLeg2ExchangeEl.textContent = entrySellExName.length > 4 ? entrySellExName.substring(0, 4).toUpperCase() : entrySellExName.toUpperCase();
            popupLeg2InstrumentEl.textContent = entrySellInstrument.toUpperCase().includes('SPOT') ? 'S' : 'F';
            popupLeg2PriceEl.textContent = formatPriceForDisplay(initialSellPrice);

            // Inicia o loop para buscar dados ao vivo
            updateWithLiveData(); // Faz uma chamada inicial
            window.profitUpdateInterval = setInterval(updateWithLiveData, 1000);

            // Configura o botão de abrir gráficos
            openChartButtonEl.addEventListener('click', () => {
                 if (window.opener && typeof window.opener.abrirGraficosComLayout === 'function') {
                    // Chama a função da janela principal que já sabe como abrir tudo
                    window.opener.abrirGraficosComLayout(entryBuyExName, entryBuyInstrument, entrySellExName, entrySellInstrument, pair, params.get('direction'), null);
                 }
            });
        };

        window.onunload = () => {
            if (window.profitUpdateInterval) clearInterval(window.profitUpdateInterval);
        };
    </script>
</body>
</html>