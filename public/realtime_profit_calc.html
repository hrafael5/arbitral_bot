<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Entrada</title>
    <style>
        body { 
            font-family: 'Segoe UI', 'Roboto', sans-serif; 
            margin: 0; 
            background-color: #161b22; 
            color: #c9d1d9; 
            font-size: 14px; 
            min-height: 180px; /* Altura mínima ajustada para o novo tamanho */
            min-width: 280px; /* Largura mínima para garantir que o conteúdo caiba */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden; 
        }
        .popup-container { 
            background-color: #0d1117; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            width: 100%; 
            max-width: 380px; /* Reduzido para um visual mais compacto */
            height: auto;
            box-sizing: border-box; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            border: 1px solid #30363d;
        }
        .pair-header { /* Nome do par um pouco menor para dar destaque ao lucro */
            font-size: 22px; 
            font-weight: 500; /* Menos bold */
            margin-bottom: 2px; /* Menos espaço abaixo */
            color: #adb5bd; /* Cor um pouco mais suave */
            text-align: center;
        }
        .entry-label {
            font-size: 10px; 
            color: #8b949e; 
            margin-bottom: 10px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .data-row {
            display: flex;
            justify-content: space-around; 
            align-items: flex-start; 
            width: 100%;
            margin-bottom: 12px; 
            padding: 0 5px; 
            box-sizing: border-box;
            gap: 5px; 
        }
        .data-column {
            text-align: center;
            flex: 1 1 0; 
            min-width: 70px; 
        }
        .data-column.center {
            border-left: 1px solid #30363d;
            border-right: 1px solid #30363d;
            padding: 0 8px; 
            margin: 0 3px; 
            flex: 1.5 1 0; 
        }
        .data-column .label {
            font-size: 9px; 
            color: #8b949e;
            margin-bottom: 2px;
            display: block;
            text-transform: uppercase;
            white-space: nowrap; 
        }
        .data-column .value {
            font-size: 16px; 
            font-weight: 500;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            word-break: break-all; 
        }
        .data-column.center .value#popupProfitE {
            font-size: 22px; 
            font-weight: 600; 
        }

        .profit-value.positive { color: #3fb950; } 
        .profit-value.negative { color: #f85149; } 
        .profit-value.zero { color: #8b949e; }

        .sub-profit-container {
            margin-top: 2px; 
        }
        .sub-profit-container .label-s {
            font-size: 8px; 
            color: #8b949e;
            text-transform: none; 
            display: block;
        }
        .sub-profit-container .value-s {
            font-size: 12px; 
            font-weight: 500;
             font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
        }

        .actions-footer {
            display: flex;
            justify-content: center; 
            align-items: center;
            width: 100%;
            margin-top: 5px; 
            padding-top: 10px; 
            border-top: 1px solid #30363d;
        }
        #openChartButton { 
            padding: 6px 12px; 
            font-size: 12px;
            cursor: pointer;
            background-color: #238636; 
            color: white;
            border: 1px solid #2ea043;
            border-radius: 6px;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        #openChartButton:hover {
            background-color: #2ea043; 
        }
        
    </style>
</head>
<body>
    <div class="popup-container">
        <div class="pair-header">
            <span id="popupPairDisplay">PAR</span>
        </div>
        <div class="entry-label">Entrada</div>
        
        <div class="data-row">
            <div class="data-column">
                <span class="label"><span id="popupLeg1Exchange">EX1</span> (<span id="popupLeg1Instrument">S</span>)</span>
                <span class="value" id="popupLeg1Price">0.00000</span>
            </div>
            <div class="data-column center">
                <span class="label">Entrada</span>
                <span class="value profit-value zero" id="popupProfitE">-0.00%</span>
                <div class="sub-profit-container">
                    <span class="label-s">Saída (Inverso):</span>
                    <span class="value-s profit-value zero" id="popupProfitS">-0.00%</span>
                </div>
            </div>
            <div class="data-column">
                <span class="label"><span id="popupLeg2Exchange">EX2</span> (<span id="popupLeg2Instrument">F</span>)</span>
                <span class="value" id="popupLeg2Price">0.00000</span>
            </div>
        </div>

        <div class="actions-footer">
            <button id="openChartButton">Abrir Gráficos (2)</button>
        </div>
    </div>

    <script>
        let pair = '';
        let originalDirection = ''; 
        let entryBuyExName = 'mexc'; 
        let entrySellExName = 'mexc'; 
        let entryBuyInstrumentIsSpot = true;
        let entrySellInstrumentIsSpot = false;

        const popupPairDisplayEl = document.getElementById('popupPairDisplay');
        const popupLeg1ExchangeEl = document.getElementById('popupLeg1Exchange');
        const popupLeg1InstrumentEl = document.getElementById('popupLeg1Instrument');
        const popupLeg1PriceEl = document.getElementById('popupLeg1Price');
        const popupProfitEEl = document.getElementById('popupProfitE'); 
        const popupProfitSEl = document.getElementById('popupProfitS'); 
        const popupLeg2ExchangeEl = document.getElementById('popupLeg2Exchange');
        const popupLeg2InstrumentEl = document.getElementById('popupLeg2Instrument');
        const popupLeg2PriceEl = document.getElementById('popupLeg2Price');
        
        const openChartButtonEl = document.getElementById('openChartButton');

        // Dados simulados para demonstração
        const simulatedData = {
            'BTC/USDT': {
                mexc: { spotPrice: 67850.50, futuresPrice: 67855.20, spotBid: 67848.30, futuresBid: 67853.10 },
                gateio: { spotPrice: 67860.80, futuresPrice: 67865.40, spotBid: 67858.60, futuresBid: 67863.20 }
            },
            'ETH/USDT': {
                mexc: { spotPrice: 3245.80, futuresPrice: 3246.50, spotBid: 3244.90, futuresBid: 3245.60 },
                gateio: { spotPrice: 3248.20, futuresPrice: 3249.10, spotBid: 3247.30, futuresBid: 3248.20 }
            }
        };

        const simulatedConfig = {
            exchanges: {
                mexc: { spotMakerFee: 0.0000, futuresMakerFee: 0.0001 },
                gateio: { spotMakerFee: 0.0010, futuresMakerFee: 0.0002 }
            }
        };

        function formatPriceForDisplay(price, decimals = 7) { 
            if (typeof price !== 'number' || isNaN(price)) return '-'; 
            if (price < 0.00001 && price !== 0 && price > -0.00001) return price.toPrecision(3);
            return price.toFixed(decimals); 
        }
        
        function getRelevantDecimals(price) {
            if (price === null || price === undefined || isNaN(price)) return 7;
            const absPrice = Math.abs(price);
            if (absPrice >= 100) return 2;
            if (absPrice >= 1) return 4;
            if (absPrice >= 0.01) return 5;
            if (absPrice >= 0.0001) return 6;
            return 7;
        }
        
        function formatProfitPercentageForDisplay(profitPercentage, element) {
            if (!element) return;
            let textToShow = "Dados...";
            let baseClassName = element.id === 'popupProfitS' ? 'value-s profit-value' : 'value profit-value';
            let finalClassName = `${baseClassName} zero`;

            if (typeof profitPercentage === 'number' && !isNaN(profitPercentage)) {
                textToShow = (profitPercentage >= 0 ? '+' : '') + profitPercentage.toFixed(2) + '%';
                if (profitPercentage > 0.009) finalClassName = `${baseClassName} positive`;
                else if (profitPercentage < -0.009) finalClassName = `${baseClassName} negative`;
            }
            element.textContent = textToShow;
            element.className = finalClassName;
        }

        function calculateLucroS_PopUp(dataSource) {
            const currentData = dataSource.allPairsData;
            const currentConfig = dataSource.config;

            if (!currentData[pair]) {
                console.log('[CalcPopUpS] Dados para o par não encontrados na fonte atual.');
                return NaN;
            }
            
            const configForS_BuyLeg = currentConfig.exchanges[entrySellExName.toLowerCase()]; 
            const configForS_SellLeg = currentConfig.exchanges[entryBuyExName.toLowerCase()]; 

            if (!configForS_BuyLeg || !configForS_SellLeg) {
                console.warn(`[CalcPopUpS] Config de taxas não encontrada para ${entrySellExName} ou ${entryBuyExName} (para Saída)`);
                return NaN;
            }

            const marketDataForS_BuyLeg = currentData[pair][entrySellExName.toLowerCase()];
            const marketDataForS_SellLeg = currentData[pair][entryBuyExName.toLowerCase()];

            if (!marketDataForS_BuyLeg || !marketDataForS_SellLeg) {
                console.log('[CalcPopUpS] Dados de mercado para pernas de saída não encontrados.');
                return NaN;
            }

            let price_S_Buy, fee_S_Buy;
            if (entrySellInstrumentIsSpot) {
                price_S_Buy = marketDataForS_BuyLeg.spotPrice; 
                fee_S_Buy = parseFloat(configForS_BuyLeg.spotMakerFee);
            } else {
                price_S_Buy = marketDataForS_BuyLeg.futuresPrice; 
                fee_S_Buy = parseFloat(configForS_BuyLeg.futuresMakerFee);
            }

            let price_S_Sell, fee_S_Sell;
            if (entryBuyInstrumentIsSpot) {
                price_S_Sell = marketDataForS_SellLeg.spotBid; 
                fee_S_Sell = parseFloat(configForS_SellLeg.spotMakerFee);
            } else {
                price_S_Sell = marketDataForS_SellLeg.futuresBid; 
                fee_S_Sell = parseFloat(configForS_SellLeg.futuresMakerFee);
            }
            
            if (isNaN(fee_S_Buy)) fee_S_Buy = 0;
            if (isNaN(fee_S_Sell)) fee_S_Sell = 0;

            if (typeof price_S_Buy === 'number' && typeof price_S_Sell === 'number' && price_S_Buy > 0 && !isNaN(price_S_Buy) && !isNaN(price_S_Sell)) {
                const grossSpreadS = (price_S_Sell / price_S_Buy) - 1;
                const netSpreadS = grossSpreadS - fee_S_Buy - fee_S_Sell; 
                return netSpreadS * 100; 
            }
            console.log('[CalcPopUpS] Preços ou taxas inválidos para cálculo de lucro S.');
            return NaN;
        }

        function updatePopupDisplay() {
            let dataSource = null;

            // Tenta acessar dados reais primeiro, mas com tratamento de erro CORS
            try {
                if (window.opener && !window.opener.closed && window.opener.frontendState) {
                    dataSource = window.opener.frontendState;
                    console.log('[CalcPopUpNew] Usando dados de window.opener.frontendState.');
                }
            } catch (e) {
                // Ignora erros de CORS silenciosamente
                console.log('[CalcPopUpNew] Acesso a window.opener bloqueado por CORS, usando dados simulados.');
            }

            // Fallback para dados simulados
            if (!dataSource || !dataSource.allPairsData || !dataSource.config || !dataSource.config.exchanges) {
                console.log('[CalcPopUpNew] Usando dados simulados.');
                dataSource = { allPairsData: simulatedData, config: simulatedConfig };
            }

            try {
                const currentConfig = dataSource.config;
                const currentAllPairsData = dataSource.allPairsData;

                const configEntryBuyEx = currentConfig.exchanges[entryBuyExName.toLowerCase()];
                const configEntrySellEx = currentConfig.exchanges[entrySellExName.toLowerCase()];

                if (!configEntryBuyEx || !configEntrySellEx) {
                    console.warn(`[CalcPopUpNew] Config de taxas não encontrada para ${entryBuyExName} ou ${entrySellExName}.`);
                    formatProfitPercentageForDisplay(NaN, popupProfitEEl);
                    formatProfitPercentageForDisplay(NaN, popupProfitSEl);
                    return;
                }
                
                const feeForEntryBuyOrder = entryBuyInstrumentIsSpot ? parseFloat(configEntryBuyEx.spotMakerFee) : parseFloat(configEntryBuyEx.futuresMakerFee);
                const feeForEntrySellOrder = entrySellInstrumentIsSpot ? parseFloat(configEntrySellEx.spotMakerFee) : parseFloat(configEntrySellEx.futuresMakerFee);
                
                // Acesso direto aos dados do par
                const marketDataForEntryBuyLeg = currentAllPairsData[pair] ? currentAllPairsData[pair][entryBuyExName.toLowerCase()] : null;
                const marketDataForEntrySellLeg = currentAllPairsData[pair] ? currentAllPairsData[pair][entrySellExName.toLowerCase()] : null;

                if (marketDataForEntryBuyLeg && marketDataForEntrySellLeg) {
                    const priceToBuyEntry = entryBuyInstrumentIsSpot ? marketDataForEntryBuyLeg.spotPrice : marketDataForEntryBuyLeg.futuresPrice; 
                    const priceToSellEntry = entrySellInstrumentIsSpot ? marketDataForEntrySellLeg.spotBid : marketDataForEntrySellLeg.futuresBid; 
                    
                    let netSpreadMakerEntry = NaN;
                    if (typeof priceToBuyEntry === 'number' && typeof priceToSellEntry === 'number' && priceToBuyEntry > 0 && !isNaN(priceToBuyEntry) && !isNaN(priceToSellEntry)) {
                        const grossSpreadMaker = (priceToSellEntry / priceToBuyEntry) - 1;
                        netSpreadMakerEntry = grossSpreadMaker - feeForEntryBuyOrder - feeForEntrySellOrder;
                    }
                    formatProfitPercentageForDisplay(netSpreadMakerEntry * 100, popupProfitEEl);
                    
                    const netSpreadMakerS_percentage = calculateLucroS_PopUp(dataSource);
                    formatProfitPercentageForDisplay(netSpreadMakerS_percentage, popupProfitSEl);

                    if (popupPairDisplayEl) popupPairDisplayEl.textContent = pair.split('/')[0];
                    if (popupLeg1ExchangeEl) popupLeg1ExchangeEl.textContent = entryBuyExName.length > 4 ? entryBuyExName.substring(0,4).toUpperCase() : entryBuyExName.toUpperCase();
                    if (popupLeg1InstrumentEl) popupLeg1InstrumentEl.textContent = entryBuyInstrumentIsSpot ? 'S' : 'F';
                    if (popupLeg1PriceEl) popupLeg1PriceEl.textContent = formatPriceForDisplay(priceToBuyEntry, getRelevantDecimals(priceToBuyEntry));
                    if (popupLeg2ExchangeEl) popupLeg2ExchangeEl.textContent = entrySellExName.length > 4 ? entrySellExName.substring(0,4).toUpperCase() : entrySellExName.toUpperCase();
                    if (popupLeg2InstrumentEl) popupLeg2InstrumentEl.textContent = entrySellInstrumentIsSpot ? 'S' : 'F';
                    if (popupLeg2PriceEl) popupLeg2PriceEl.textContent = formatPriceForDisplay(priceToSellEntry, getRelevantDecimals(priceToSellEntry));
                    
                } else {
                    console.log('[CalcPopUpNew] Dados de mercado para pernas de entrada não encontrados.');
                    formatProfitPercentageForDisplay(NaN, popupProfitEEl);
                    formatProfitPercentageForDisplay(NaN, popupProfitSEl);
                    if (popupLeg1PriceEl) popupLeg1PriceEl.textContent = "Dados?";
                    if (popupLeg2PriceEl) popupLeg2PriceEl.textContent = "Dados?";
                }
            } catch (e) {
                console.error("[CalcPopUpNew] Erro durante updatePopupDisplay:", e);
                formatProfitPercentageForDisplay(NaN, popupProfitEEl);
                formatProfitPercentageForDisplay(NaN, popupProfitSEl);
                if (popupProfitEEl) popupProfitEEl.textContent = "Erro";
            }
        }
        
        function getExchangeUrl(exchange, isSpot, pairForURL) {
            const exchangeLower = (exchange || '').toLowerCase();
            if (exchangeLower === 'mexc') {
                return isSpot ? `https://www.mexc.com/exchange/${pairForURL}?type=spot` : `https://futures.mexc.com/exchange/${pairForURL}`;
            } else if (exchangeLower === 'gateio' || exchangeLower === 'gate.io') {
                return isSpot ? `https://www.gate.io/trade/${pairForURL}` : `https://www.gate.io/futures_trade/USDT/${pairForURL}`;
            }
            return null;
        }

        function abrirJanelaDeGrafico(url, windowName, position) {
            if (!url) return;
            const screenWidth = window.screen.availWidth;
            const screenHeight = window.screen.availHeight;
            const windowWidth = Math.floor(screenWidth / 2) - 10;
            const windowHeight = screenHeight - 50;
            let left = (position === 'left') ? 0 : screenWidth - windowWidth;
            const features = `width=${windowWidth},height=${windowHeight},left=${left},top=0,resizable=yes,scrollbars=yes`;
            
            const newWindow = window.open(url, windowName, features);
            if (newWindow) newWindow.focus();
        }

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            pair = params.get('pair') || 'BTC/USDT'; 
            originalDirection = params.get('direction'); 
            
            entryBuyExName = params.get('buyEx') || 'mexc'; 
            entrySellExName = params.get('sellEx') || 'gateio'; 

            if (originalDirection) {
                const dirParts = originalDirection.toLowerCase().split('/');
                if (dirParts.length === 2) {
                    const buyLegFullDesc = dirParts[0].trim(); 
                    entryBuyInstrumentIsSpot = buyLegFullDesc.includes("spot");
                    const sellLegFullDesc = dirParts[1].trim(); 
                    entrySellInstrumentIsSpot = sellLegFullDesc.includes("spot");
                }
            }
            
            document.title = `Entrada: ${pair}`;
            console.log(`[CalcPopUpNew] Carregada. Par: ${pair}, DirOrig: ${originalDirection}, BuyEx: ${entryBuyExName} (Spot: ${entryBuyInstrumentIsSpot}), SellEx: ${entrySellExName} (Spot: ${entrySellInstrumentIsSpot})`);

            updatePopupDisplay(); 
            window.profitUpdateInterval = setInterval(updatePopupDisplay, 2000); 
            
            if (openChartButtonEl) {
                openChartButtonEl.addEventListener('click', () => {
                    if (!pair) { alert("Par não definido."); return; }
                    const pairForURL = pair.replace('/', '_').toUpperCase();

                    const urlLeg1 = getExchangeUrl(entryBuyExName, entryBuyInstrumentIsSpot, pairForURL);
                    const urlLeg2 = getExchangeUrl(entrySellExName, entrySellInstrumentIsSpot, pairForURL);

                    if (urlLeg1 === urlLeg2) {
                         if(urlLeg1) window.open(urlLeg1, '_blank');
                    } else {
                        abrirJanelaDeGrafico(urlLeg1, 'arbitrage_leg1_window', 'left');
                        abrirJanelaDeGrafico(urlLeg2, 'arbitrage_leg2_window', 'right');
                    }
                });
            }
        };
        window.onunload = () => { if (window.profitUpdateInterval) clearInterval(window.profitUpdateInterval); };
    </script>
</body>
</html>

